version: '1.0'

steps:
  main_clone:
    type: git-clone
    repo: ixc/project_template

  build_image:
    type: build
    image_name: interaction/project_template

  run_tests:
    type: composition
    composition: docker-compose.yml
    composition_candidates:
      django:
        command: runtests.sh --failfast .
        environment:
          DOTENV: test
        image: '${{build_image}}'
    when:
      condition:
        all:
          skip_tests_variable: lower('${{CF_SKIP_TESTS}}') != 'true'

  push_images:
    candidate: '${{build_image}}'
    type: push
    scale:
      push_branch_tag:
        tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
      push_commit_tag:
        tag: '${{CF_REVISION}}'
      push_latest_tag:
        tag: latest
        when:
          branch:
            only:
              - master
